name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only required for Organizations

      - name: Check for common secret patterns
        run: |
          echo "Scanning for common secret patterns..."
          
          # Check for Google API keys
          if grep -r "AIza[0-9A-Za-z\\-_]\{35\}" --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" .; then
            echo "‚ùå Google API key pattern detected!"
            exit 1
          fi
          
          # Check for AWS keys
          if grep -r "AKIA[0-9A-Z]\{16\}" --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" .; then
            echo "‚ùå AWS access key pattern detected!"
            exit 1
          fi
          
          # Check for private keys
          if grep -r "BEGIN.*PRIVATE KEY" --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" .; then
            echo "‚ùå Private key detected!"
            exit 1
          fi
          
          # Check for hardcoded passwords
          if grep -ri "password.*=.*['\"][^'\"]\{8,\}['\"]" --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" --exclude-dir=test .; then
            echo "‚ö†Ô∏è  Potential hardcoded password detected!"
            echo "Please verify this is not a real credential."
          fi
          
          echo "‚úÖ No obvious secrets detected in custom patterns"

      - name: Check for .env files
        run: |
          echo "Checking for committed .env files..."
          if find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
            echo "‚ùå .env file(s) found in repository!"
            find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*"
            exit 1
          fi
          echo "‚úÖ No .env files committed"

      - name: Verify .env.example has no real secrets
        run: |
          echo "Checking .env.example for placeholder values..."
          if [ -f ".env.example" ]; then
            # Check for example/placeholder values
            if grep -q "your-.*-key\|change-in-production\|example\|placeholder\|YOUR_" .env.example; then
              echo "‚úÖ .env.example contains placeholder values (good)"
            else
              echo "‚ö†Ô∏è  .env.example might contain real values. Please verify."
            fi
            
            # Check for specific exposed secrets
            if grep -q "jYbS0m7xBY\|AIzaSyAJMqJy6WejEwQ3JgHx1hv9FQxdfoAe3FU" .env.example; then
              echo "‚ùå Known exposed secret found in .env.example!"
              exit 1
            fi
          fi
          echo "‚úÖ .env.example validation passed"

      - name: Security summary
        if: success()
        run: |
          echo "üîí Security Scan Summary"
          echo "========================"
          echo "‚úÖ TruffleHog scan: Passed"
          echo "‚úÖ Gitleaks scan: Passed"
          echo "‚úÖ Pattern matching: Passed"
          echo "‚úÖ .env check: Passed"
          echo "‚úÖ No secrets detected"
